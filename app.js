// Config
const CONFIG = {
    owner: 'seedgen-public',
    repo: 'deploy',
    api: 'https://api.github.com'
};

// 카테고리 (순서: OS -> DBMS -> WEB/WAS -> PC)
const CATEGORIES = [
    {
        name: 'OS',
        cssClass: 'os',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="20" height="14" x="2" y="3" rx="2"/><line x1="8" x2="16" y1="21" y2="21"/><line x1="12" x2="12" y1="17" y2="21"/></svg>',
        patterns: ['Linux', 'Ubuntu', 'WindowsServer']
    },
    {
        name: 'DBMS',
        cssClass: 'dbms',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><ellipse cx="12" cy="5" rx="9" ry="3"/><path d="M3 5V19A9 3 0 0 0 21 19V5"/><path d="M3 12A9 3 0 0 0 21 12"/></svg>',
        patterns: ['MySQL', 'Oracle', 'MSSQL', 'PostgreSQL', 'MariaDB']
    },
    {
        name: 'WEB/WAS',
        cssClass: 'web',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 2a14.5 14.5 0 0 0 0 20 14.5 14.5 0 0 0 0-20"/><path d="M2 12h20"/></svg>',
        patterns: ['Apache', 'Nginx', 'Tomcat', 'IIS']
    },
    {
        name: 'PC',
        cssClass: 'pc',
        icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect width="18" height="12" x="3" y="4" rx="2" ry="2"/><line x1="2" x2="22" y1="20" y2="20"/></svg>',
        patterns: ['WindowsPC', 'PC_Check']
    }
];

// Simple Icons SVG paths
const BRAND_ICONS = {
    mysql: '<svg viewBox="0 0 24 24"><path d="M16.405 5.501c-.115 0-.193.014-.274.033v.013h.014c.054.104.146.18.214.273.054.107.1.214.154.32l.014-.015c.094-.066.14-.172.14-.333-.04-.047-.046-.094-.08-.14-.04-.067-.126-.1-.18-.153zM5.77 18.695h-.927a50.854 50.854 0 00-.27-4.41h-.008l-1.41 4.41H2.45l-1.4-4.41h-.01a72.892 72.892 0 00-.195 4.41H0c.055-1.966.192-3.81.41-5.53h1.15l1.335 4.064h.008l1.347-4.063h1.095c.242 2.015.384 3.86.428 5.53zm4.017-4.08c-.378 2.045-.876 3.533-1.492 4.46-.482.716-1.01 1.073-1.583 1.073-.153 0-.34-.046-.566-.138v-.494c.11.017.24.026.386.026.268 0 .483-.075.647-.222.197-.18.295-.382.295-.605 0-.155-.077-.47-.23-.944L6.23 14.615h.91l.727 2.36c.164.536.233.91.205 1.123.4-1.064.678-2.227.835-3.483zm12.325 4.08h-2.63v-5.53h.885v4.85h1.745zm-3.32.135l-1.016-.5c.09-.076.177-.158.255-.25.433-.506.648-1.258.648-2.253 0-1.83-.718-2.746-2.155-2.746-.704 0-1.254.232-1.65.697-.43.508-.646 1.256-.646 2.245 0 .972.19 1.686.574 2.14.35.41.877.615 1.583.615.264 0 .506-.033.725-.098l1.325.772.36-.623zM15.5 17.588c-.225-.36-.337-.94-.337-1.736 0-1.393.424-2.09 1.27-2.09.443 0 .77.167.977.5.224.362.336.936.336 1.723 0 1.404-.424 2.108-1.27 2.108-.445 0-.77-.167-.978-.5zm-1.658-.425c0 .47-.172.856-.516 1.156-.344.3-.803.45-1.384.45-.543 0-1.064-.172-1.573-.515l.237-.476c.438.22.833.328 1.19.328.332 0 .593-.073.783-.22a.754.754 0 00.3-.615c0-.33-.23-.61-.648-.845-.388-.213-1.163-.657-1.163-.657-.422-.307-.632-.636-.632-1.177 0-.45.157-.81.47-1.085.315-.278.72-.415 1.22-.415.512 0 .98.136 1.4.41l-.213.476a2.726 2.726 0 00-1.064-.23c-.283 0-.502.068-.654.206a.685.685 0 00-.248.524c0 .328.234.61.666.85.393.215 1.187.67 1.187.67.433.305.648.63.648 1.168zm9.382-5.852c-.535-.014-.95.04-1.297.188-.1.04-.26.04-.274.167.055.053.063.14.11.214.08.134.218.313.346.407.14.11.28.216.427.31.26.16.555.255.81.416.145.094.293.213.44.313.073.05.12.14.214.172v-.02c-.046-.06-.06-.147-.105-.214-.067-.067-.134-.127-.2-.193a3.223 3.223 0 00-.695-.675c-.214-.146-.682-.35-.77-.595l-.013-.014c.146-.013.32-.066.46-.106.227-.06.435-.047.67-.106.106-.027.213-.06.32-.094v-.06c-.12-.12-.21-.283-.334-.395a8.867 8.867 0 00-1.104-.823c-.21-.134-.476-.22-.697-.334-.08-.04-.214-.06-.26-.127-.12-.146-.19-.34-.275-.514a17.69 17.69 0 01-.547-1.163c-.12-.262-.193-.523-.34-.763-.69-1.137-1.437-1.826-2.586-2.5-.247-.14-.543-.2-.856-.274-.167-.008-.334-.02-.5-.027-.11-.047-.216-.174-.31-.235-.38-.24-1.364-.76-1.644-.072-.18.434.267.862.422 1.082.115.153.26.328.34.5.047.116.06.235.107.356.106.294.207.622.347.897.073.14.153.287.247.413.054.073.146.107.167.227-.094.136-.1.334-.154.5-.24.757-.146 1.693.194 2.25.107.166.362.534.703.393.3-.12.234-.5.32-.835.02-.08.007-.133.048-.187v.015c.094.188.188.367.274.555.206.328.566.668.867.895.16.12.287.328.487.402v-.02h-.015c-.043-.058-.1-.086-.154-.133a3.445 3.445 0 01-.35-.4 8.76 8.76 0 01-.747-1.218c-.11-.21-.202-.436-.29-.643-.04-.08-.04-.2-.107-.24-.1.146-.247.273-.32.453-.127.288-.14.642-.188 1.01-.027.007-.014 0-.027.014-.214-.052-.287-.274-.367-.46-.2-.475-.233-1.238-.06-1.785.047-.14.247-.582.167-.716-.042-.127-.174-.2-.247-.303a2.478 2.478 0 01-.24-.427c-.16-.374-.24-.788-.414-1.162-.08-.173-.22-.354-.334-.513-.127-.18-.267-.307-.368-.52-.033-.073-.08-.194-.027-.274.014-.054.042-.075.094-.09.088-.072.335.022.422.062.247.1.455.194.662.334.094.066.195.193.315.226h.14c.214.047.455.014.655.073.355.114.675.28.962.46a5.953 5.953 0 012.085 2.286c.08.154.115.295.188.455.14.33.313.663.455.982.14.315.275.636.476.897.1.14.502.213.682.286.133.06.34.115.46.188.23.14.454.3.67.454.11.076.443.243.463.378z"/></svg>',
    oracle: '<svg viewBox="0 0 24 24"><path d="M16.412 4.412h-8.82a7.588 7.588 0 0 0-.008 15.176h8.828a7.588 7.588 0 0 0 0-15.176zm-.193 12.502H7.786a4.915 4.915 0 0 1 0-9.828h8.433a4.914 4.914 0 1 1 0 9.828z"/></svg>',
    mssql: '<svg viewBox="0 0 24 24"><path d="M4.105 4.105S9.158 1.58 11.684.316a3.079 3.079 0 0 1 1.481-.315c.766.047 1.677.788 1.677.788L24 9.948v9.789h-4.263V24H.002v-8.556C.002 13.337-.074 9.2 4.105 4.105zm4.334 10.369l2.06 3.293 4.078-5.797-6.138 2.504zm10.413 5.315V12.32l-7.832 3.2 3.2 5.128h4.226c.146-.022.406-.22.406-.86zM4 17.717c0 .206.024.342.065.443.4.973 1.063 1.84 1.063 1.84h8.236l-3.278-5.238c-1.506.388-4.3 1.862-5.564 2.606-.224.132-.469.27-.522.349z"/></svg>',
    postgresql: '<svg viewBox="0 0 24 24"><path d="M23.5594 14.7228a.5269.5269 0 0 0-.0563-.1191c-.139-.2632-.4768-.3418-1.0074-.2321-1.6533.3411-2.2935.1312-2.5256-.0191 1.342-2.0482 2.445-4.522 3.0411-6.8297.2714-1.0507.7982-3.5237.1222-4.7316a1.5641 1.5641 0 0 0-.1509-.235C21.6931.9086 19.8007.0248 17.5099.0005c-1.4947-.0158-2.7705.3461-3.1161.4794a9.449 9.449 0 0 0-.5159-.0816 8.044 8.044 0 0 0-1.3114-.1278c-1.1822-.0184-2.2038.2642-3.0498.8406-.8573-.3211-4.7888-1.645-7.2219.0788C.9359 2.1526.3086 3.8733.4302 6.3165c.0377.7562.2798 2.2445.6821 3.9127.4012 1.6652.888 3.1399 1.3734 4.1561.4866 1.0185.9311 1.6228 1.3857 1.8376.2401.1133.5608.1763.9501.1763.5368 0 1.1986-.1253 1.9739-.3748.2464-.0793.4929-.1585.7094-.2338.0162.0349.0324.0699.0486.0999.0979.1859.2618.4267.4357.6088-.1167.0295-.2334.0591-.3501.0886-1.7496.4428-3.3412.8449-3.4292 1.9173-.0297.3631.0674.7286.2921 1.0869.8282 1.321 3.2039 2.0768 6.3118 2.0105.2086-.0044.4173-.0132.6268-.026l-.0024.0013c1.2866-.0469 2.5959-.4747 3.7461-1.188.09-.0558.2356-.0514.3727-.0465l.0134.0005c.0578.0023.1156.0044.1735.0053 1.0652.0159 1.9352-.1362 2.5878-.4519.5765-.2788 1.0133-.6786 1.3139-1.0873a1.8573 1.8573 0 0 0 .2866-.4015c.0315-.0594.0529-.1015.0659-.1267l.0099-.0193c.1914-.3564.3588-.6689.4891-.9497a.3726.3726 0 0 0 .0317-.1067.55.55 0 0 0-.0017-.1364c.0178-.0445.0344-.0858.0502-.1254.1488-.3717.2461-.6171.2819-.6684.5765-.8259 1.0504-1.3739 1.4227-1.6464a.5634.5634 0 0 0 .212-.5765z"/></svg>',
    apache: '<svg viewBox="0 0 24 24"><path d="M17.805 2.197v.066h.156v.44h.072v-.44h.156v-.066zm.9 0l-.175.353-.172-.353h-.087v.506h.067V2.3l.172.35h.045l.172-.35v.404h.066v-.506zm-4.257 1c-.204.31-.424.66-.66 1.06l-.04.062a44.457 44.457 0 00-1.265 2.29c-.187.36-.38.742-.577 1.146l2.267-.25c.66-.302.955-.578 1.242-.976a15.5 15.5 0 00.23-.342c.23-.363.46-.763.663-1.16.197-.386.37-.767.505-1.11.083-.22.15-.422.198-.6.042-.158.074-.307.1-.45-.884.15-1.965.295-2.668.33z"/></svg>',
    nginx: '<svg viewBox="0 0 24 24"><path d="M12 0L1.605 6v12L12 24l10.395-6V6L12 0zm6 16.59c0 .705-.646 1.29-1.529 1.29-.631 0-1.351-.255-1.801-.81l-6-7.141v6.66c0 .721-.57 1.29-1.274 1.29H7.32c-.721 0-1.29-.6-1.29-1.29V7.41c0-.705.63-1.29 1.5-1.29.646 0 1.38.255 1.83.81l5.97 7.141V7.41c0-.721.6-1.29 1.29-1.29h.075c.72 0 1.29.6 1.29 1.29v9.18H18z"/></svg>',
    tomcat: '<svg viewBox="0 0 24 24"><path d="M12.66 3.494c-.377.637-.544 2.114-.502 3.162l-.005.004c.036.946.165 1.816.372 2.615-3.096.767-6.466 2.795-8.352 4.754-.882-1.19-1.232-2.168-1.336-2.908-.131-.936.092-1.794.646-2.482.867-1.077 2.098-1.153 3.365-.94-.025.2.001.391.081.51.335.494 2.135.668 3.21.189-.793-1.112-2.4-1.654-2.844-1.437a.762.762 0 00-.335.359c-.438-.078-.873-.137-1.19-.134-1.117.008-1.971.398-2.61 1.193-.628.78-.882 1.747-.734 2.8.14.996.633 2.055 1.46 3.154-.138.147-.27.293-.398.436C1.473 17.023 0 19.44 0 19.842v.207h2.658l-.046-.246c-.15-.793.15-1.785.763-2.526.386-.465 1.024-.996 2.027-1.241.891.87 2.027 1.794 3.291 2.685h1.976v-.208a.678.678 0 00-.327-.577c-.312-.204-.794-.232-1.237-.081-.421-.47-.658-1.098-.709-1.877 4.287.38 8.388 2.11 13.015 4.528h2.546l.033-.167c.048-.237-.082-.556-.346-.851-.456-.51-1.349-.752-2.095-.734-.514-.612-3.342-3.591-3.507-3.765a9.626 9.626 0 002.673-2.847h1.388v-.298H20.89a9.81 9.81 0 00.223-.419h.989v-.299h-.845c.628-1.359.975-2.918.942-4.625l.003.002c-.002-.468-.147-2.445-.415-2.989-.726.276-2.047 1.17-2.346 2.084a14.557 14.557 0 00-4.463.056c-.237-.984-1.423-1.736-2.318-2.16z"/></svg>',
    linux: '<svg viewBox="0 0 24 24"><path d="M12.504 0c-.155 0-.315.008-.48.021-4.226.333-3.105 4.807-3.17 6.298-.076 1.092-.3 1.953-1.05 3.02-.885 1.051-2.127 2.75-2.716 4.521-.278.832-.41 1.684-.287 2.489a.424.424 0 00-.11.135c-.26.268-.45.6-.663.839-.199.199-.485.267-.797.4-.313.136-.658.269-.864.68-.09.189-.136.394-.132.602 0 .199.027.4.055.536.058.399.116.728.04.97-.249.68-.28 1.145-.106 1.484.174.334.535.47.94.601.81.2 1.91.135 2.774.6.926.466 1.866.67 2.616.47.526-.116.97-.464 1.208-.946.587-.003 1.23-.269 2.26-.334.699-.058 1.574.267 2.577.2.025.134.063.198.114.333l.003.003c.391.778 1.113 1.132 1.884 1.071.771-.06 1.592-.536 2.257-1.306.631-.765 1.683-1.084 2.378-1.503.348-.199.629-.469.649-.853.023-.4-.2-.811-.714-1.376v-.097l-.003-.003c-.17-.2-.25-.535-.338-.926-.085-.401-.182-.786-.492-1.046h-.003c-.059-.054-.123-.067-.188-.135a.357.357 0 00-.19-.064c.431-1.278.264-2.55-.173-3.694-.533-1.41-1.465-2.638-2.175-3.483-.796-1.005-1.576-1.957-1.56-3.368.026-2.152.236-6.133-3.544-6.139z"/></svg>',
    ubuntu: '<svg viewBox="0 0 24 24"><path d="M17.61.455a3.41 3.41 0 0 0-3.41 3.41 3.41 3.41 0 0 0 3.41 3.41 3.41 3.41 0 0 0 3.41-3.41 3.41 3.41 0 0 0-3.41-3.41zM12.92.8C8.923.777 5.137 2.941 3.148 6.451a4.5 4.5 0 0 1 .26-.007 4.92 4.92 0 0 1 2.585.737A8.316 8.316 0 0 1 12.688 3.6 4.944 4.944 0 0 1 13.723.834 11.008 11.008 0 0 0 12.92.8zm9.226 4.994a4.915 4.915 0 0 1-1.918 2.246 8.36 8.36 0 0 1-.273 8.303 4.89 4.89 0 0 1 1.632 2.54 11.156 11.156 0 0 0 .559-13.089zM3.41 7.932A3.41 3.41 0 0 0 0 11.342a3.41 3.41 0 0 0 3.41 3.409 3.41 3.41 0 0 0 3.41-3.41 3.41 3.41 0 0 0-3.41-3.41zm2.027 7.866a4.908 4.908 0 0 1-2.915.358 11.1 11.1 0 0 0 7.991 6.698 11.234 11.234 0 0 0 2.422.249 4.879 4.879 0 0 1-.999-2.85 8.484 8.484 0 0 1-.836-.136 8.304 8.304 0 0 1-5.663-4.32zm11.405.928a3.41 3.41 0 0 0-3.41 3.41 3.41 3.41 0 0 0 3.41 3.41 3.41 3.41 0 0 0 3.41-3.41 3.41 3.41 0 0 0-3.41-3.41z"/></svg>',
    windows: '<svg viewBox="0 0 24 24"><path d="M0 3.449L9.75 2.1v9.451H0m10.949-9.602L24 0v11.4H10.949M0 12.6h9.75v9.451L0 20.699M10.949 12.6H24V24l-12.9-1.801"/></svg>'
};

// DOM
const els = {
    version: document.getElementById('current-version'),
    date: document.getElementById('release-date'),
    container: document.getElementById('scripts-container'),
    historySection: document.getElementById('history-section'),
    historyList: document.getElementById('history-list')
};

// Init
document.addEventListener('DOMContentLoaded', loadReleases);

// Load releases
async function loadReleases() {
    try {
        const res = await fetch(`${CONFIG.api}/repos/${CONFIG.owner}/${CONFIG.repo}/releases`);
        if (!res.ok) throw new Error('릴리즈를 불러올 수 없습니다');

        const releases = await res.json();

        if (releases.length === 0) {
            els.container.innerHTML = '<div class="empty">릴리즈가 없습니다</div>';
            return;
        }

        renderRelease(releases[0]);

        if (releases.length > 1) {
            renderHistory(releases.slice(1));
        } else {
            els.historySection.style.display = 'none';
        }

    } catch (err) {
        els.container.innerHTML = `<div class="error">${err.message}</div>`;
    }
}

// 파일 분류
function getCategory(filename) {
    for (const cat of CATEGORIES) {
        if (cat.patterns.some(p => filename.includes(p))) {
            return cat;
        }
    }
    return { name: '기타', cssClass: 'etc', icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>' };
}

// 파일에서 브랜드 추출
function getBrandFromFilename(filename) {
    const lower = filename.toLowerCase();
    if (lower.includes('mysql')) return 'mysql';
    if (lower.includes('oracle')) return 'oracle';
    if (lower.includes('mssql')) return 'mssql';
    if (lower.includes('postgresql')) return 'postgresql';
    if (lower.includes('apache')) return 'apache';
    if (lower.includes('nginx')) return 'nginx';
    if (lower.includes('tomcat')) return 'tomcat';
    if (lower.includes('ubuntu')) return 'ubuntu';
    if (lower.includes('linux')) return 'linux';
    if (lower.includes('windows')) return 'windows';
    return null;
}

// OS 판별
function getOS(filename) {
    const ext = filename.split('.').pop().toLowerCase();
    if (ext === 'sh') return 'Linux';
    if (ext === 'ps1' || ext === 'bat' || ext === 'cmd') return 'Windows';
    return ext.toUpperCase();
}

// Render release
function renderRelease(release) {
    els.version.textContent = release.tag_name;

    if (release.published_at) {
        els.date.textContent = new Date(release.published_at).toLocaleDateString('ko-KR');
    }

    if (!release.assets || release.assets.length === 0) {
        els.container.innerHTML = '<div class="empty">배포된 파일이 없습니다</div>';
        return;
    }

    // 카테고리별 그룹화
    const groups = {};
    CATEGORIES.forEach(c => groups[c.name] = { icon: c.icon, cssClass: c.cssClass, files: [] });
    groups['기타'] = { icon: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>', cssClass: 'etc', files: [] };

    release.assets.forEach(asset => {
        const cat = getCategory(asset.name);
        groups[cat.name].files.push(asset);
    });

    // 렌더링
    let html = '';
    for (const [name, data] of Object.entries(groups)) {
        if (data.files.length === 0) continue;

        html += `
            <div class="category">
                <div class="category-header">
                    <span class="icon ${data.cssClass}">${data.icon}</span>
                    <span>${name}</span>
                    <span class="count">${data.files.length}개</span>
                </div>
                <div class="file-list">
                    ${data.files.map(f => {
                        const brand = getBrandFromFilename(f.name);
                        const iconClass = brand || 'default';
                        const iconSvg = brand ? BRAND_ICONS[brand] : '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/></svg>';
                        return `
                        <a href="${f.browser_download_url}" class="file-item" download>
                            <span class="file-icon ${iconClass}">${iconSvg}</span>
                            <span class="file-name">${f.name}</span>
                            <span class="file-os">${getOS(f.name)}</span>
                        </a>
                    `}).join('')}
                </div>
            </div>
        `;
    }

    els.container.innerHTML = html;
}

// Render history
function renderHistory(releases) {
    els.historyList.innerHTML = releases.map(r => `
        <div class="history-item">
            <span class="history-version">${r.tag_name}</span>
            <span class="history-date">${new Date(r.published_at).toLocaleDateString('ko-KR')}</span>
            <span class="history-count">${r.assets?.length || 0}개 파일</span>
            <a href="${r.html_url}" target="_blank" class="history-link">GitHub</a>
        </div>
    `).join('');
}
